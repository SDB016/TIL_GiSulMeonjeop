# 네트워크 통신 흐름  
## 인터넷 
  
전세계에 걸쳐 파일 전송등의 데이터 통신 서비스를 받을 수 있는 **컴퓨터 네트워크의 시스템**         
참고로, 프로토콜은 네트워크 통신을 위해 미리 정해 놓은 공통된 메뉴얼을 의미한다.    

## TCP/IP 계층
TCP/IP란, 인터넷에서 컴퓨터들이 서로 정보를 주고받는데 쓰이는 **프로토콜의 집합** 
  
1. Application Layer : 
    * 특정 서비스를 제공하기 위해 애플리케이션끼리 정보를 주고 받는 것   
    * 애플리케이션끼리 어떤 데이터를 교환할지 정하는 것 
    * FTP, HTTP, SSH, TELNET, DNS, SMTP 
2. Transport Layer : 
    * 송신된 데이터를 수신측 애플리케이션에 확실히 전달하게 한다.     
    * 네트워크 통신을 하는 애플리케이션은 포트번호를 사용하는데,  
      Transport Layer는 포트번호를 사용해서 애플리케이션을 찾아주는 역할을 한다.   
    * TCP, UDP, RTP, RTCP  
3. Internet Layer :
    * 수신 측까지 데이터를 전달하기 위해 사용된다.  
    * IP, ARP, ICMP, RARP, OSPF 
4. Network Access Layer : 
    * 네트워크에 직접 연결된 기기 간의 데이터 전송을 돕는다.    
    * Ethernet, PPP, Token Ring

## TCP/IP 흐름  

면접 질문 : www.google.com을 입력하면 무슨일이 일어날까?        
     
* 구글 웹 서버의 80 포트로 HttpRequest 메시지를 보낸다는 뜻이다.    
* 해당 요청을 인터넷에 전달하기 위해 우리는 패킷을 만든다.    
* 패킷에는 각 계층에 필요한 정보들이 담겨야 한다.    

### Application Layer
  
* HTTP Request가 들어간다.     
  
### Transport Layer   

![header-600x336](https://user-images.githubusercontent.com/50267433/146664001-8ebbb357-db86-46a2-9f84-77be0a71a48e.jpeg)
  
TCP/UDP 패킷은 위와 같다.      
여기서 우리가 눈여결 볼 점은, SP/DP 이다.            
  
* SP : 시작 포트 번호(내 컴퓨터 포트)     
* DP : 목적지 포트 번호(애플리케이션의 포트)    

TCP는 신뢰성을 증시하는 프로토콜로, 

* 혼잡제어 
* 흐름제어
* 

반면에 UDP는 SP/DP와 데이터만 가지고 있다.   


### Internet Layer   

![IPv4_header](https://user-images.githubusercontent.com/50267433/146664080-f788ca9c-ea5c-4a22-95a4-e44aea6c1ad9.jpeg)
 
여기서도 중요한 정보는 SA와 DA이다.    
  
* SA : 시작 IP 주소(내 IP 주소)    
* DA : 목적지 IP 주소(모르지만 도메인은 알고있다.)    

DA 즉, 목적지 IP 주소를 알기위해 DNS 프로토콜을 이용해서 도매인의 IP주소를 받아오는 작업을 진행해야한다.       

브라우저는 OS에게  domain 에 대한 ip 주소를 알고 싶다고 요청을 한다.      
(os는 DNS 어떻게알지? - DNS 서버 주소는 이미 컴퓨터에 등록되어 있음)       
  
DNS 프로토콜 또한, Applicaion Layer의 프로토콜인데 53번 포트를 사용한다.          
DNS 도 HTTP Request와 비슷하게 도메인이 담긴 쿼리를 도메인 서버로 보낸다.         
그러면 도메인 서버가 IP주소를 응답해준다.    
    
DNS는 TransportLayer에서 UDP라는 프로토콜을 사용한다.     
UDP는 TCP와 다르게 헤더가 간단하다(위에서 보면 알 수 있듯이)          
DNS를 통해 성공적으로 도메인에 대한 IP 주소를 받아왔다.     

### Network Access Layer 
  
Ethternet 프로토콜에 대한 헤더를 만들어야 하는데 아직 맥주소를 모른다.      
이제 Mac 주소를 어떻게 알아 와야하는지 알아봐야 한다.       

이전까지는 우리가 목표인 구글 서버에 대한 정보가 필요했다.          
그러면 MAC주소도 구글의 MAC 주소를 알아야할까?        
아니다 여기서 필요한건, 실제 우리집 컴퓨터와 물리적으로 연결된 공유기를 말하는 것이다.     
공유기를 통해 다른 네트워크와 연결이 가능하기 때문이다.    

그렇다면 공유기의 MAC 주소는 어떻게 알까? -> 이미 게이트웨이에 대한 IP 주소는 등록되어있다.         
IP주소를 MAC 주소로 변환해주는 ARP 프로토콜을 이용하면 된다.           
이러면 모든 준비를 마치고 데이터를 전송하 준비가 되었다.     
   
## 신뢰할 수 있는 TCP    
   
데이터 전송을 위한 준비를 마쳤다.      
그런데 우리가 설정한 전송 프로토콜이 TCP여서 추가 작업을 진해해야한다.      
      
TCP는 연결 지향형 프로토콜이다.         
그래서 TCP 프로토콜은 데이터를 전송하기 전에, 송신측과 수신측이 서로 연결되는 작업이 필요하다.       
그리고 이렇게 송수신측을 연결하는 작업을 3-way-handshake 작업이라고 부른다.     
   
![tcp-headers-f2c0881ea4c94e919794b7c0677ab90a](https://user-images.githubusercontent.com/50267433/146664502-83b54de5-a877-47eb-b11c-1de6d039afc8.jpeg)

TCP Header를 보게되면, Control flags(컨트롤 비트)라는 영역이 존재하고 그 뜻은 아래와 같다.  

*
*
*
*
*
    
이 중에서 TCP 3-way-handshake 는 ACK(액)와 SYN(싱)을 사용한다.        

### TCP 3 Way HandShake 
    
1. 클라이언트는 서버에게 접속을 요청하는 SYN 패킷을 보낸다.     
2. 서버는 SYN 요청을 받고, 요청을 수락한다는 ACK 와 SYN 플래그가 설정된 패킷을 보낸다.      
3. 클라이언트는 서버에게 다시 ACK 을 보낸다.       

이제부터 연결이 이루어지고 데이터가 오가게 된다.     

#### 이제 전송해보자   
이제 3-way-handshaking으로 연결이 성립되었으니 데이터가 보내질 차례다.   
참고로, 내가 사용하는 컴퓨터는 private ip를 사용한다.    
private ip는 외부의 네트워크 환경에서 IP주소를 찾지 못하게 하기위해 설계된 것이다.   

하지만, 실제 데이터를 보내려면 이 private ip를 실제 public ip로 보내서 전송해야한다.      
그래서 공유기(게이트웨이)를 통해서 나갈때, private ip를 public ip 주소로 변환해서 나가는 작업을 하는데  
이 같은 작업이 바로 NAT(Network Address Translation)이다.    
  
이후, 우리집 공유기를 걸쳐 구글 서버에 도착하기 위해 여러 라우터를 거쳐야한다.       
라우터는 네트워크와 네트워크를 연결해주는 역할을 하는데, 이러한 라우터들을 여럿 거쳐가야한다.        
참고로, 라우터가 목적지 경로를 찾아 나가는 과정을 라우팅이라고 한다.     
 
라우팅을 거쳐 구글 서버가 연결된 라우터까지 데이터가 도착을 한다면       
패킷의 IP 헤더에 기록된 구글 서버 IP 주소를 통해 MAC 주소를 얻어와야한다.     
이때, 이전에 설명했던 ARP와 반대 기능을 가진 RARP 프로토콜을 사용한다.    
 
